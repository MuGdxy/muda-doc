<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>MUDA: Main Page</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">MUDA
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.8 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><li class="level1"><a href="#autotoc_md1">Overview</a><ul><li class="level2"><a href="#autotoc_md2">Launch</a></li>
<li class="level2"><a href="#autotoc_md3">Logger</a></li>
<li class="level2"><a href="#autotoc_md4">Buffer</a></li>
<li class="level2"><a href="#autotoc_md5">Viewer In Kernel</a></li>
<li class="level2"><a href="#autotoc_md6">Event And Stream</a></li>
<li class="level2"><a href="#autotoc_md7">Asynchronous Operation</a></li>
<li class="level2"><a href="#autotoc_md8">[Extension] Linear System Support</a></li>
<li class="level2"><a href="#autotoc_md9">[Extension] Field Layout</a></li>
<li class="level2"><a href="#autotoc_md10">Compute Graph</a></li>
<li class="level2"><a href="#autotoc_md11">Dynamic Parallelism</a></li>
<li class="level2"><a href="#autotoc_md12">MUDA vs. CUDA</a></li>
</ul>
</li>
<li class="level1"><a href="#autotoc_md13">Build</a><ul><li class="level2"><a href="#autotoc_md14">Xmake</a></li>
<li class="level2"><a href="#autotoc_md15">Cmake</a></li>
<li class="level2"><a href="#autotoc_md16">Copy Headers</a></li>
<li class="level2"><a href="#autotoc_md17">Macro</a></li>
</ul>
</li>
<li class="level1"><a href="#autotoc_md18">Tutorial</a></li>
<li class="level1"><a href="#autotoc_md19">Documentation</a></li>
<li class="level1"><a href="#autotoc_md20">Examples</a></li>
<li class="level1"><a href="#autotoc_md21">Contributing</a></li>
<li class="level1"><a href="#autotoc_md22">Related Work</a></li>
</ul>
</div>
<div class="textblock"><p>MUDA is <b>Î¼-CUDA</b>, yet another painless CUDA programming <b>paradigm</b>.</p>
<blockquote class="doxtable">
<p>&zwj;COVER THE LAST MILE OF CUDA </p>
</blockquote>
<h1><a class="anchor" id="autotoc_md1"></a>
Overview</h1>
<h2><a class="anchor" id="autotoc_md2"></a>
Launch</h2>
<p>Simple, self-explanatory, intellisense-friendly Launcher.</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;muda/muda.h&gt;</span></div>
<div class="line"><span class="keyword">using namespace </span>muda;</div>
<div class="line">__global__ <span class="keywordtype">void</span> raw_kernel()</div>
<div class="line">{</div>
<div class="line">    printf(<span class="stringliteral">&quot;hello muda!\n&quot;</span>);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">int</span> main()</div>
<div class="line">{</div>
<div class="line">    <span class="comment">// just launch</span></div>
<div class="line">    <a class="code hl_class" href="classmuda_1_1_launch.html">Launch</a>(1, 1)</div>
<div class="line">        .apply(</div>
<div class="line">        [] __device__() </div>
<div class="line">        {</div>
<div class="line">            print(<span class="stringliteral">&quot;hello muda!\n&quot;</span>); </div>
<div class="line">        }).wait();</div>
<div class="line">    </div>
<div class="line">    <span class="keyword">constexpr</span> <span class="keywordtype">int</span> N = 8;</div>
<div class="line">    <span class="comment">// dynamic grid</span></div>
<div class="line">    <a class="code hl_class" href="classmuda_1_1_parallel_for.html">ParallelFor</a>(256 <span class="comment">/*block size*/</span>)</div>
<div class="line">        .apply(N,</div>
<div class="line">        [] __device__(<span class="keywordtype">int</span> i) </div>
<div class="line">        {</div>
<div class="line">            print(<span class="stringliteral">&quot;hello muda %d!\n&quot;</span>, i); </div>
<div class="line">        }).wait();</div>
<div class="line">    </div>
<div class="line">    <span class="comment">// grid stride loop</span></div>
<div class="line">    <a class="code hl_class" href="classmuda_1_1_parallel_for.html">ParallelFor</a>(8  <span class="comment">/*grid size*/</span>, </div>
<div class="line">                32 <span class="comment">/*block size*/</span>)</div>
<div class="line">        .apply(N,</div>
<div class="line">        [] __device__(<span class="keywordtype">int</span> i) </div>
<div class="line">        {</div>
<div class="line">            print(<span class="stringliteral">&quot;hello muda %d!\n&quot;</span>, i); </div>
<div class="line">        }).wait();</div>
<div class="line">    </div>
<div class="line">    <span class="comment">// intellisense-friendly wrapper </span></div>
<div class="line">    <a class="code hl_class" href="classmuda_1_1_kernel.html">Kernel</a>{raw_kernel}();</div>
<div class="line">    <a class="code hl_class" href="classmuda_1_1_kernel.html">Kernel</a>{32<span class="comment">/*grid size*/</span>, 64<span class="comment">/*block size*/</span>,0<span class="comment">/*shared memory*/</span>, stream, other_kernel}(...)</div>
<div class="line">    </div>
<div class="line">    <a class="code hl_class" href="classmuda_1_1_stream.html">Stream</a> stream;</div>
<div class="line">    on(stream).wait();</div>
<div class="line">}</div>
<div class="ttc" id="aclassmuda_1_1_kernel_html"><div class="ttname"><a href="classmuda_1_1_kernel.html">muda::Kernel</a></div><div class="ttdef"><b>Definition</b> kernel.h:11</div></div>
<div class="ttc" id="aclassmuda_1_1_launch_html"><div class="ttname"><a href="classmuda_1_1_launch.html">muda::Launch</a></div><div class="ttdoc">A wrapper of raw cuda kernel launch in muda style, removing the &lt;&lt;&lt;&gt;&gt;&gt; usage, for better intellisense...</div><div class="ttdef"><b>Definition</b> launch.h:86</div></div>
<div class="ttc" id="aclassmuda_1_1_parallel_for_html"><div class="ttname"><a href="classmuda_1_1_parallel_for.html">muda::ParallelFor</a></div><div class="ttdoc">a frequently used parallel for loop, DynamicBlockDim and GridStrideLoop strategy are provided,...</div><div class="ttdef"><b>Definition</b> parallel_for.h:116</div></div>
<div class="ttc" id="aclassmuda_1_1_stream_html"><div class="ttname"><a href="classmuda_1_1_stream.html">muda::Stream</a></div><div class="ttdoc">RAII wrapper for cudaStream.</div><div class="ttdef"><b>Definition</b> stream.h:14</div></div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md3"></a>
Logger</h2>
<div class="fragment"><div class="line"><a class="code hl_class" href="classmuda_1_1_logger.html">Logger</a> logger;</div>
<div class="line"><a class="code hl_class" href="classmuda_1_1_launch.html">Launch</a>(2, 2)</div>
<div class="line">    .apply(</div>
<div class="line">        [logger = logger.viewer()] __device__() <span class="keyword">mutable</span></div>
<div class="line">        {</div>
<div class="line">            <span class="comment">// type override</span></div>
<div class="line">            logger &lt;&lt; <span class="stringliteral">&quot;int2: &quot;</span> &lt;&lt; make_int2(1, 2) &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">            logger &lt;&lt; <span class="stringliteral">&quot;float3: &quot;</span> &lt;&lt; make_float3(1.0f, 2.0f, 3.0f) &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">        })</div>
<div class="line">    .wait();</div>
<div class="line"><span class="comment">// download the result to any ostream you like. </span></div>
<div class="line">logger.retrieve(std::cout);</div>
<div class="ttc" id="aclassmuda_1_1_logger_html"><div class="ttname"><a href="classmuda_1_1_logger.html">muda::Logger</a></div><div class="ttdef"><b>Definition</b> logger.h:35</div></div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md4"></a>
Buffer</h2>
<div class="fragment"><div class="line"><a class="code hl_class" href="classmuda_1_1_device_buffer.html">DeviceBuffer&lt;int&gt;</a> buffer;</div>
<div class="line"> </div>
<div class="line"><span class="comment">// copy from std::vector</span></div>
<div class="line">std::vector&lt;int&gt; host(8);</div>
<div class="line">buffer.copy_from(host);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// copy to raw memory</span></div>
<div class="line"><span class="keywordtype">int</span> host_array[8];</div>
<div class="line">buffer.copy_to(host_array);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// use BufferView to copy sub-buffer</span></div>
<div class="line">buffer.view(0,4).copy_from(host.data());</div>
<div class="line"> </div>
<div class="line"><a class="code hl_class" href="classmuda_1_1_device_buffer.html">DeviceBuffer&lt;int&gt;</a> dst_buffer{4};</div>
<div class="line"><span class="comment">// use BufferView to copy sub-buffer</span></div>
<div class="line">buffer.view(0,4).copy_to(dst_buffer.view());</div>
<div class="line"> </div>
<div class="line"><span class="comment">// safe and easy resize</span></div>
<div class="line"><a class="code hl_class" href="classmuda_1_1_device_buffer2_d.html">DeviceBuffer2D&lt;int&gt;</a> buffer2d;</div>
<div class="line">buffer.resize(<a class="code hl_class" href="classmuda_1_1_extent2_d.html">Extent2D</a>{5, 5}, 1);</div>
<div class="line">buffer.resize(<a class="code hl_class" href="classmuda_1_1_extent2_d.html">Extent2D</a>{7, 2}, 2);</div>
<div class="line">buffer.resize(<a class="code hl_class" href="classmuda_1_1_extent2_d.html">Extent2D</a>{2, 7}, 3);</div>
<div class="line">buffer.resize(<a class="code hl_class" href="classmuda_1_1_extent2_d.html">Extent2D</a>{9, 9}, 4);</div>
<div class="line"><span class="comment">// subview </span></div>
<div class="line">buffer2d.view(<a class="code hl_class" href="classmuda_1_1_offset2_d.html">Offset2D</a>{1,1}, <a class="code hl_class" href="classmuda_1_1_extent2_d.html">Extent2D</a>{3,3});</div>
<div class="line">buffer2d.copy_to(host);</div>
<div class="line"> </div>
<div class="line"><a class="code hl_class" href="classmuda_1_1_device_buffer3_d.html">DeviceBuffer3D&lt;int&gt;</a> buffer3d;</div>
<div class="line">buffer3d.resize(<a class="code hl_class" href="classmuda_1_1_extent3_d.html">Extent3D</a>{3, 4, 5}, 1);</div>
<div class="line">buffer3d.copy_to(host);</div>
<div class="ttc" id="aclassmuda_1_1_device_buffer2_d_html"><div class="ttname"><a href="classmuda_1_1_device_buffer2_d.html">muda::DeviceBuffer2D</a></div><div class="ttdef"><b>Definition</b> device_buffer_2d.h:13</div></div>
<div class="ttc" id="aclassmuda_1_1_device_buffer3_d_html"><div class="ttname"><a href="classmuda_1_1_device_buffer3_d.html">muda::DeviceBuffer3D</a></div><div class="ttdef"><b>Definition</b> device_buffer_3d.h:23</div></div>
<div class="ttc" id="aclassmuda_1_1_device_buffer_html"><div class="ttname"><a href="classmuda_1_1_device_buffer.html">muda::DeviceBuffer</a></div><div class="ttdoc">A std::vector like wrapper of cuda device memory, allows user to:</div><div class="ttdef"><b>Definition</b> device_buffer.h:46</div></div>
<div class="ttc" id="aclassmuda_1_1_extent2_d_html"><div class="ttname"><a href="classmuda_1_1_extent2_d.html">muda::Extent2D</a></div><div class="ttdef"><b>Definition</b> extent.h:10</div></div>
<div class="ttc" id="aclassmuda_1_1_extent3_d_html"><div class="ttname"><a href="classmuda_1_1_extent3_d.html">muda::Extent3D</a></div><div class="ttdef"><b>Definition</b> extent.h:40</div></div>
<div class="ttc" id="aclassmuda_1_1_offset2_d_html"><div class="ttname"><a href="classmuda_1_1_offset2_d.html">muda::Offset2D</a></div><div class="ttdef"><b>Definition</b> extent.h:72</div></div>
</div><!-- fragment --><p>result of buffer2d:</p>
<p><img src="./img/buffer2d_resize.svg" alt="buffer2d_resize" style="pointer-events: none;" class="inline"/></p>
<h2><a class="anchor" id="autotoc_md5"></a>
Viewer In Kernel</h2>
<div class="fragment"><div class="line"><a class="code hl_class" href="classmuda_1_1_device_var.html">DeviceVar&lt;int&gt;</a> single;</div>
<div class="line"><a class="code hl_class" href="classmuda_1_1_device_buffer.html">DeviceBuffer&lt;int&gt;</a> array;</div>
<div class="line"><a class="code hl_class" href="classmuda_1_1_device_buffer2_d.html">DeviceBuffer2D&lt;int&gt;</a> array2d;</div>
<div class="line"><a class="code hl_class" href="classmuda_1_1_device_buffer3_d.html">DeviceBuffer3D&lt;int&gt;</a> array3d;</div>
<div class="line"><a class="code hl_class" href="classmuda_1_1_logger.html">Logger</a> logger;</div>
<div class="line"><a class="code hl_class" href="classmuda_1_1_launch.html">Launch</a>().apply(</div>
<div class="line">[</div>
<div class="line">    single  = single.viewer().name(<span class="stringliteral">&quot;single&quot;</span>), <span class="comment">// give a name for more readable debug info</span></div>
<div class="line">    array   = buffer.viewer().name(<span class="stringliteral">&quot;array&quot;</span>),</div>
<div class="line">    array2d = buffer_2d.viewer().name(<span class="stringliteral">&quot;array2d&quot;</span>),</div>
<div class="line">    array3d = buffer_3d.viewer().name(<span class="stringliteral">&quot;array3d&quot;</span>),</div>
<div class="line">    logger  = logger.viewer().name(<span class="stringliteral">&quot;logger&quot;</span>),</div>
<div class="line">    ...</div>
<div class="line">] __device__ () <span class="keyword">mutable</span></div>
<div class="line">{</div>
<div class="line">    single = 1;</div>
<div class="line">    array(i) = 1;</div>
<div class="line">    array2d(offset_in_height, offset_in_width) = 1;</div>
<div class="line">    array3d(offset_in_depth, offset_in_height, offset_in_width) = 1;</div>
<div class="line">    logger &lt;&lt; 1;</div>
<div class="line">});</div>
<div class="ttc" id="aclassmuda_1_1_device_var_html"><div class="ttname"><a href="classmuda_1_1_device_var.html">muda::DeviceVar</a></div><div class="ttdef"><b>Definition</b> device_var.h:11</div></div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md6"></a>
Event And Stream</h2>
<div class="fragment"><div class="line"><a class="code hl_class" href="classmuda_1_1_stream.html">Stream</a>         s1, s2;</div>
<div class="line"><a class="code hl_class" href="classmuda_1_1_event.html">Event</a>          set_value_done;</div>
<div class="line"> </div>
<div class="line"><a class="code hl_class" href="classmuda_1_1_device_var.html">DeviceVar&lt;int&gt;</a> v = 1;</div>
<div class="line">on(s1)</div>
<div class="line">    .next&lt;<a class="code hl_class" href="classmuda_1_1_launch.html">Launch</a>&gt;(1, 1)</div>
<div class="line">    .apply(</div>
<div class="line">        [v = v.viewer()] __device__() mutable</div>
<div class="line">        {</div>
<div class="line">            <span class="keywordtype">int</span> next = 2;</div>
<div class="line">            v = next;</div>
<div class="line">        })</div>
<div class="line">    .record(set_value_done)</div>
<div class="line">    .apply(</div>
<div class="line">        [] __device__()</div>
<div class="line">        {</div>
<div class="line">            some_work();</div>
<div class="line">        });</div>
<div class="line"> </div>
<div class="line">on(s2)</div>
<div class="line">    .when(set_value_done)</div>
<div class="line">    .next&lt;<a class="code hl_class" href="classmuda_1_1_launch.html">Launch</a>&gt;(1, 1)</div>
<div class="line">    .apply([v = v.viewer()] __device__()</div>
<div class="line">           { <span class="keywordtype">int</span> res = v; });</div>
<div class="ttc" id="aclassmuda_1_1_event_html"><div class="ttname"><a href="classmuda_1_1_event.html">muda::Event</a></div><div class="ttdoc">RAII wrapper for cudaEvent.</div><div class="ttdef"><b>Definition</b> event.h:15</div></div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md7"></a>
Asynchronous Operation</h2>
<div class="fragment"><div class="line"><span class="comment">// kernel launch</span></div>
<div class="line"><a class="code hl_class" href="classmuda_1_1_kernel.html">Kernel</a>{..., f}(...);</div>
<div class="line"><a class="code hl_class" href="classmuda_1_1_launch.html">Launch</a>(stream).apply(...).wait();</div>
<div class="line"><a class="code hl_class" href="classmuda_1_1_parallel_for.html">ParallelFor</a>(stream).apply(N, ...).wait();</div>
<div class="line"> </div>
<div class="line"><span class="comment">// graph launch</span></div>
<div class="line"><a class="code hl_class" href="classmuda_1_1_graph_launch.html">GraphLaunch</a>().launch(graph).wait();</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Memory</span></div>
<div class="line"><a class="code hl_class" href="classmuda_1_1_memory.html">Memory</a>(stream).copy(...).wait();</div>
<div class="line"><a class="code hl_class" href="classmuda_1_1_memory.html">Memory</a>(stream).set(...).wait();</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Buffer: for BufferView/Buffer2DView/Buffer3DView</span></div>
<div class="line"><a class="code hl_class" href="classmuda_1_1_buffer_launch.html">BufferLaunch</a>(stream).copy(<a class="code hl_class" href="classmuda_1_1_buffer_view.html">BufferView</a>, ...).wait();</div>
<div class="line"><a class="code hl_class" href="classmuda_1_1_buffer_launch.html">BufferLaunch</a>(stream).fill(<a class="code hl_class" href="classmuda_1_1_buffer_view.html">BufferView</a>,...).wait();</div>
<div class="ttc" id="aclassmuda_1_1_buffer_launch_html"><div class="ttname"><a href="classmuda_1_1_buffer_launch.html">muda::BufferLaunch</a></div><div class="ttdef"><b>Definition</b> buffer_launch.h:37</div></div>
<div class="ttc" id="aclassmuda_1_1_buffer_view_html"><div class="ttname"><a href="classmuda_1_1_buffer_view.html">muda::BufferView</a></div><div class="ttdef"><b>Definition</b> buffer_view.h:134</div></div>
<div class="ttc" id="aclassmuda_1_1_graph_launch_html"><div class="ttname"><a href="classmuda_1_1_graph_launch.html">muda::GraphLaunch</a></div><div class="ttdef"><b>Definition</b> graph_launch.h:8</div></div>
<div class="ttc" id="aclassmuda_1_1_memory_html"><div class="ttname"><a href="classmuda_1_1_memory.html">muda::Memory</a></div><div class="ttdef"><b>Definition</b> memory.h:8</div></div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md8"></a>
[Extension] Linear System Support</h2>
<p>[We are still working on this part]</p>
<p><b>MUDA</b> supports basic linear system operations. e.g.:</p>
<ol type="1">
<li>Sparse Matrix Format Conversion</li>
<li>Sparse Matrix Assembly</li>
<li>Linear System Solving</li>
</ol>
<p><img src="./img/linear_system.drawio.svg" alt="" style="pointer-events: none; zoom:50%;" class="inline"/></p>
<p>The only thing you need to do is to declare a <code><a class="el" href="classmuda_1_1_linear_system_context.html">muda::LinearSystemContext</a></code>.</p>
<div class="fragment"><div class="line"><a class="code hl_class" href="classmuda_1_1_linear_system_context.html">LinearSystemContext</a> ctx;</div>
<div class="line"><span class="comment">// non-unique triplets of (row_index, col_index, block3x3)</span></div>
<div class="line"><a class="code hl_class" href="classmuda_1_1_device_triplet_matrix.html">DeviceTripletMatrix&lt;float, 3&gt;</a> A_triplet;</div>
<div class="line"><span class="comment">// setup the triplet matrix dimension</span></div>
<div class="line">A_triplet.reshape(block_rows,block_cols);</div>
<div class="line"><span class="comment">// resize the triplets, we should know the total count of the triplets.</span></div>
<div class="line">A_triplet.resize_triplets(hessian_count); </div>
<div class="line"> </div>
<div class="line"><span class="comment">// unique triplets of (row_index, col_index, block3x3) faster SPMV than TripletMatrix</span></div>
<div class="line"><a class="code hl_class" href="classmuda_1_1_device_b_c_o_o_matrix.html">DeviceBCOOMatrix&lt;float,3&gt;</a> A_bcoo; </div>
<div class="line"> </div>
<div class="line"><span class="comment">// block compressed sparse row format, faster SPMV than BCOOMatrix</span></div>
<div class="line"><a class="code hl_class" href="classmuda_1_1_device_b_s_r_matrix.html">DeviceBSRMatrix&lt;float,3&gt;</a> A_bsr; </div>
<div class="line"> </div>
<div class="line"><span class="comment">// compressed sparse row format, slower SPMV than BSRMatrix</span></div>
<div class="line"><a class="code hl_class" href="classmuda_1_1_device_c_s_r_matrix.html">DeviceCSRMatrix&lt;float,3&gt;</a> A_csr</div>
<div class="line"> </div>
<div class="line"><span class="comment">// trivial dense matrix </span></div>
<div class="line"><a class="code hl_class" href="classmuda_1_1_device_dense_matrix.html">DeviceDenseMatrix&lt;float&gt;</a> A_dense; </div>
<div class="line"> </div>
<div class="line"><span class="comment">// convert:</span></div>
<div class="line">ctx.convert(A_triplet, A_bcoo);</div>
<div class="line">ctx.convert(A_bcoo, A_bsr);</div>
<div class="line">ctx.convert(A_bsr, A_dense);</div>
<div class="line">ctx.convert(A_bsr, A_csr);</div>
<div class="line">ctx.convert(A_bcoo, A_dense);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// so for the Sparse Vector ...</span></div>
<div class="ttc" id="aclassmuda_1_1_device_b_c_o_o_matrix_html"><div class="ttname"><a href="classmuda_1_1_device_b_c_o_o_matrix.html">muda::DeviceBCOOMatrix</a></div><div class="ttdef"><b>Definition</b> device_bcoo_matrix.h:10</div></div>
<div class="ttc" id="aclassmuda_1_1_device_b_s_r_matrix_html"><div class="ttname"><a href="classmuda_1_1_device_b_s_r_matrix.html">muda::DeviceBSRMatrix</a></div><div class="ttdef"><b>Definition</b> device_bsr_matrix.h:17</div></div>
<div class="ttc" id="aclassmuda_1_1_device_c_s_r_matrix_html"><div class="ttname"><a href="classmuda_1_1_device_c_s_r_matrix.html">muda::DeviceCSRMatrix</a></div><div class="ttdef"><b>Definition</b> device_csr_matrix.h:16</div></div>
<div class="ttc" id="aclassmuda_1_1_device_dense_matrix_html"><div class="ttname"><a href="classmuda_1_1_device_dense_matrix.html">muda::DeviceDenseMatrix</a></div><div class="ttdef"><b>Definition</b> device_dense_matrix.h:10</div></div>
<div class="ttc" id="aclassmuda_1_1_device_triplet_matrix_html"><div class="ttname"><a href="classmuda_1_1_device_triplet_matrix.html">muda::DeviceTripletMatrix</a></div><div class="ttdef"><b>Definition</b> device_triplet_matrix.h:14</div></div>
<div class="ttc" id="aclassmuda_1_1_linear_system_context_html"><div class="ttname"><a href="classmuda_1_1_linear_system_context.html">muda::LinearSystemContext</a></div><div class="ttdef"><b>Definition</b> linear_system_context.h:28</div></div>
</div><!-- fragment --><p>We only allow users to assemble a Sparse Matrix from Triplet Matrix. And allow users to read from BCOOMatrix.</p>
<p>To assemble a Triplet Matrix, user need to use the <code>viewer</code> of a Triplet Matrix.</p>
<div class="fragment"><div class="line"><a class="code hl_class" href="classmuda_1_1_device_triplet_matrix.html">DeviceTripletMatrix&lt;float, 3&gt;</a> A_triplet;</div>
<div class="line">A_triplet.resize(block_rows,block_cols,hessian_count);</div>
<div class="line"><a class="code hl_class" href="classmuda_1_1_device_dense_vector.html">DeviceDenseVector&lt;float&gt;</a> x, b;</div>
<div class="line">x.resize(block_rows * 3);</div>
<div class="line">b.resize(block_rows * 3)</div>
<div class="line"> </div>
<div class="line"><a class="code hl_class" href="classmuda_1_1_parallel_for.html">ParallelFor</a>(256<span class="comment">/*block size*/</span>)</div>
<div class="line">    .apply(hessian_count,</div>
<div class="line">    [</div>
<div class="line">        H = A_triplet.viewer().name(<span class="stringliteral">&quot;Hessian&quot;</span>),</div>
<div class="line">        g = x.viewer().name(<span class="stringliteral">&quot;gradient&quot;</span>)</div>
<div class="line">        <span class="comment">// some infos to build up hessian and gradient</span></div>
<div class="line">    ] __device__(<span class="keywordtype">int</span> i) </div>
<div class="line">    {</div>
<div class="line">        <span class="keywordtype">int</span> row, col;</div>
<div class="line">        Eigen::Matrix3f hessian; <span class="comment">// fill the local hessian, using your infos</span></div>
<div class="line">        Eigen::Vector3f gradient;</div>
<div class="line">        </div>
<div class="line">        <span class="comment">// write the (row, col, hessian) to the i-th triplet</span></div>
<div class="line">        H(i).write(row,col, hessin);</div>
<div class="line">        </div>
<div class="line">        <span class="comment">// atomic add the gradient vector</span></div>
<div class="line">        g.segment&lt;3&gt;(i * 3).atomic_add(gradient);</div>
<div class="line">    }).wait();</div>
<div class="line"> </div>
<div class="line"><span class="comment">// convert to bcoo for better performance on SPMV.</span></div>
<div class="line">ctx.convert(A_triplet, A_bcoo);</div>
<div class="line">ctx.convert(A_bcoo, A_bsr);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// maybe in some iterative solver:</span></div>
<div class="line">ctx.spmv(A_bsr.cview(), x.cview(), b.view());</div>
<div class="ttc" id="aclassmuda_1_1_device_dense_vector_html"><div class="ttname"><a href="classmuda_1_1_device_dense_vector.html">muda::DeviceDenseVector</a></div><div class="ttdef"><b>Definition</b> device_dense_vector.h:10</div></div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md9"></a>
[Extension] Field Layout</h2>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;muda/ext/field.h&gt;</span> <span class="comment">// all you need for muda::Field</span></div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> field_example(FieldEntryLayout layout)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">using namespace </span>muda;</div>
<div class="line">    <span class="keyword">using namespace </span>Eigen;</div>
<div class="line"> </div>
<div class="line">    <a class="code hl_class" href="classmuda_1_1_field.html">Field</a> field;</div>
<div class="line">    <span class="comment">// create a subfield called &quot;particle&quot;</span></div>
<div class="line">    <span class="comment">// any entry in this field has the same size</span></div>
<div class="line">    <span class="keyword">auto</span>&amp; particle = field[<span class="stringliteral">&quot;particle&quot;</span>];</div>
<div class="line">    <span class="keywordtype">float</span> dt       = 0.01f;</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// build the field:</span></div>
<div class="line">    <span class="comment">// auto builder = particle.AoSoA(); // compile time layout</span></div>
<div class="line">    <span class="keyword">auto</span> builder = particle.builder(FieldEntryLayout::AoSoA);  <span class="comment">// runtime layout</span></div>
<div class="line">    <span class="keyword">auto</span>&amp; m      = builder.entry(<span class="stringliteral">&quot;mass&quot;</span>).scalar&lt;<span class="keywordtype">float</span>&gt;();</div>
<div class="line">    <span class="keyword">auto</span>&amp; pos    = builder.entry(<span class="stringliteral">&quot;position&quot;</span>).vector3&lt;<span class="keywordtype">float</span>&gt;();</div>
<div class="line">    <span class="keyword">auto</span>&amp; pos_old = builder.entry(<span class="stringliteral">&quot;position_old&quot;</span>).vector3&lt;<span class="keywordtype">float</span>&gt;();</div>
<div class="line">    <span class="keyword">auto</span>&amp; vel     = builder.entry(<span class="stringliteral">&quot;velocity&quot;</span>).vector3&lt;<span class="keywordtype">float</span>&gt;();</div>
<div class="line">    <span class="keyword">auto</span>&amp; force   = builder.entry(<span class="stringliteral">&quot;force&quot;</span>).vector3&lt;<span class="keywordtype">float</span>&gt;();</div>
<div class="line">    <span class="comment">// matrix is also supported, but in this example we don&#39;t use it</span></div>
<div class="line">    <span class="keyword">auto</span>&amp; I = builder.entry(<span class="stringliteral">&quot;inertia&quot;</span>).matrix3x3&lt;<span class="keywordtype">float</span>&gt;();</div>
<div class="line">    builder.build();  <span class="comment">// finish building the field</span></div>
<div class="line"> </div>
<div class="line">    <span class="comment">// set size of the particle attributes</span></div>
<div class="line">    <span class="keyword">constexpr</span> <span class="keywordtype">int</span> N = 10;</div>
<div class="line">    particle.resize(N);</div>
<div class="line"> </div>
<div class="line">    <a class="code hl_class" href="classmuda_1_1_logger.html">Logger</a> logger;</div>
<div class="line"> </div>
<div class="line">    <a class="code hl_class" href="classmuda_1_1_parallel_for.html">ParallelFor</a>(256)</div>
<div class="line">        .kernel_name(<span class="stringliteral">&quot;setup_vars&quot;</span>)</div>
<div class="line">        .apply(N,</div>
<div class="line">               [logger = logger.viewer(),</div>
<div class="line">                m      = m.viewer(),</div>
<div class="line">                pos    = pos.viewer(),</div>
<div class="line">                vel    = vel.viewer(),</div>
<div class="line">                f      = force.viewer()] $(<span class="keywordtype">int</span> i)</div>
<div class="line">               {</div>
<div class="line">                   m(i)   = 1.0f;</div>
<div class="line">                   pos(i) = Vector3f::Ones();</div>
<div class="line">                   vel(i) = Vector3f::Zero();</div>
<div class="line">                   f(i)   = Vector3f{0.0f, -9.8f, 0.0f};</div>
<div class="line"> </div>
<div class="line">                   logger &lt;&lt; <span class="stringliteral">&quot;--------------------------------\n&quot;</span></div>
<div class="line">                          &lt;&lt; <span class="stringliteral">&quot;i=&quot;</span> &lt;&lt; i &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span></div>
<div class="line">                          &lt;&lt; <span class="stringliteral">&quot;m=&quot;</span> &lt;&lt; m(i) &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span></div>
<div class="line">                          &lt;&lt; <span class="stringliteral">&quot;pos=&quot;</span> &lt;&lt; pos(i) &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span></div>
<div class="line">                          &lt;&lt; <span class="stringliteral">&quot;vel=&quot;</span> &lt;&lt; vel(i) &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span></div>
<div class="line">                          &lt;&lt; <span class="stringliteral">&quot;f=&quot;</span> &lt;&lt; f(i) &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">               })</div>
<div class="line">        .wait();</div>
<div class="line"> </div>
<div class="line">    logger.retrieve();</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// safe resize, the data will be copied to the new buffer.</span></div>
<div class="line">    <span class="comment">// here we just show the possibility</span></div>
<div class="line">    <span class="comment">// later we only work on the first N particles</span></div>
<div class="line">    particle.resize(N * 2);</div>
<div class="line"> </div>
<div class="line">    <a class="code hl_class" href="classmuda_1_1_parallel_for.html">ParallelFor</a>(256)</div>
<div class="line">        .kernel_name(<span class="stringliteral">&quot;integration&quot;</span>)</div>
<div class="line">        .apply(N,</div>
<div class="line">               [logger = logger.viewer(),</div>
<div class="line">                m      = m.cviewer(),</div>
<div class="line">                pos    = pos.viewer(),</div>
<div class="line">                vel    = vel.viewer(),</div>
<div class="line">                f      = force.cviewer(),</div>
<div class="line">                dt] $(<span class="keywordtype">int</span> i)</div>
<div class="line">               {</div>
<div class="line">                   <span class="keyword">auto</span>     x = pos(i);</div>
<div class="line">                   <span class="keyword">auto</span>     v = vel(i);</div>
<div class="line">                   Vector3f a = f(i) / m(i);</div>
<div class="line"> </div>
<div class="line">                   v = v + a * dt;</div>
<div class="line">                   x = x + v * dt;</div>
<div class="line"> </div>
<div class="line">                   logger &lt;&lt; <span class="stringliteral">&quot;--------------------------------\n&quot;</span></div>
<div class="line">                          &lt;&lt; <span class="stringliteral">&quot;i=&quot;</span> &lt;&lt; i &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span></div>
<div class="line">                          &lt;&lt; <span class="stringliteral">&quot;m=&quot;</span> &lt;&lt; m(i) &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span></div>
<div class="line">                          &lt;&lt; <span class="stringliteral">&quot;pos=&quot;</span> &lt;&lt; pos(i) &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span></div>
<div class="line">                          &lt;&lt; <span class="stringliteral">&quot;vel=&quot;</span> &lt;&lt; vel(i) &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span></div>
<div class="line">                          &lt;&lt; <span class="stringliteral">&quot;f=&quot;</span> &lt;&lt; f(i) &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">               })</div>
<div class="line">        .wait();</div>
<div class="line"> </div>
<div class="line">    logger.retrieve();</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// copy between entry and host</span></div>
<div class="line">    std::vector&lt;Vector3f&gt; positions;</div>
<div class="line">    pos.copy_to(positions);</div>
<div class="line">    pos.copy_from(positions);</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// copy between entries</span></div>
<div class="line">    pos_old.copy_from(pos);</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// copy between buffer and entry</span></div>
<div class="line">    <a class="code hl_class" href="classmuda_1_1_device_buffer.html">DeviceBuffer&lt;Vector3f&gt;</a> pos_buf;</div>
<div class="line">    pos.copy_to(pos_buf);</div>
<div class="line">    pos.copy_from(pos_buf);</div>
<div class="line">}</div>
<div class="ttc" id="aclassmuda_1_1_field_html"><div class="ttname"><a href="classmuda_1_1_field.html">muda::Field</a></div><div class="ttdef"><b>Definition</b> field.h:17</div></div>
</div><!-- fragment --><p>Note that every <code>FieldEntry</code> has a <code>View</code> called <code>FieldEntryView</code>. A <code>FieldEntryView</code> can be regarded as a <code>ComputeGraphVar</code>(see below), which means <code>FieldEntry</code> can also be used in <code>ComputeGraph</code>.</p>
<h2><a class="anchor" id="autotoc_md10"></a>
Compute Graph</h2>
<p>Define <code>MUDA_WITH_COMPUTE_GRAPH</code> to turn on <code>Compute Graph</code> support.</p>
<p><b>MUDA</b> can generate <code>cudaGraph</code> nodes and dependencies from your <code>eval()</code> call. And the <code>cudaGraphExec</code> will be automatically updated (minimally) if you update a <code><a class="el" href="classmuda_1_1_compute_graph_var.html">muda::ComputeGraphVar</a></code>. More details in <a href="https://zhuanlan.zhihu.com/p/658080362">zhihu_ZH</a>.</p>
<p>Define a muda compute graph:</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> compute_graph_simple()</div>
<div class="line">{</div>
<div class="line">    <a class="code hl_class" href="classmuda_1_1_compute_graph_var_manager.html">ComputeGraphVarManager</a> manager;</div>
<div class="line">    <a class="code hl_class" href="classmuda_1_1_compute_graph.html">ComputeGraph</a> graph{manager};</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// 1) define GraphVars</span></div>
<div class="line">    <span class="keyword">auto</span>&amp; N   = manager.create_var&lt;<span class="keywordtype">size_t</span>&gt;(<span class="stringliteral">&quot;N&quot;</span>);</div>
<div class="line">    <span class="comment">// BufferView represents a fixed range of memory</span></div>
<div class="line">    <span class="comment">// dynamic memory allocation is not allowed in GraphVars</span></div>
<div class="line">    <span class="keyword">auto</span>&amp; x_0 = manager.create_var&lt;<a class="code hl_class" href="classmuda_1_1_buffer_view.html">BufferView&lt;Vector3&gt;</a>&gt;(<span class="stringliteral">&quot;x_0&quot;</span>);</div>
<div class="line">    <span class="keyword">auto</span>&amp; x   = manager.create_var&lt;<a class="code hl_class" href="classmuda_1_1_buffer_view.html">BufferView&lt;Vector3&gt;</a>&gt;(<span class="stringliteral">&quot;x&quot;</span>);</div>
<div class="line">    <span class="keyword">auto</span>&amp; y   = manager.create_var&lt;<a class="code hl_class" href="classmuda_1_1_buffer_view.html">BufferView&lt;Vector3&gt;</a>&gt;(<span class="stringliteral">&quot;y&quot;</span>);</div>
<div class="line">    </div>
<div class="line">    <span class="comment">// 2) create GraphNode</span></div>
<div class="line">    graph.create_node(<span class="stringliteral">&quot;cal_x_0&quot;</span>) &lt;&lt; [&amp;]</div>
<div class="line">    {</div>
<div class="line">        <span class="comment">// initialize values</span></div>
<div class="line">        <a class="code hl_class" href="classmuda_1_1_parallel_for.html">ParallelFor</a>(256).apply(N.eval(),</div>
<div class="line">                               [x_0 = x_0.eval().viewer()] __device__(<span class="keywordtype">int</span> i) <span class="keyword">mutable</span></div>
<div class="line">                               { x_0(i) = Vector3::Ones(); });</div>
<div class="line">    };</div>
<div class="line"> </div>
<div class="line">    graph.create_node(<span class="stringliteral">&quot;copy_to_x&quot;</span>) <span class="comment">// copy</span></div>
<div class="line">        &lt;&lt; [&amp;] { <a class="code hl_class" href="classmuda_1_1_buffer_launch.html">BufferLaunch</a>().copy(x.eval(), x_0.ceval()); };</div>
<div class="line"> </div>
<div class="line">    graph.create_node(<span class="stringliteral">&quot;copy_to_y&quot;</span>) <span class="comment">// copy</span></div>
<div class="line">        &lt;&lt; [&amp;] { <a class="code hl_class" href="classmuda_1_1_buffer_launch.html">BufferLaunch</a>().copy(y.eval(), x_0.ceval()); };</div>
<div class="line"> </div>
<div class="line">    graph.create_node(<span class="stringliteral">&quot;print_x_y&quot;</span>) &lt;&lt; [&amp;]</div>
<div class="line">    {</div>
<div class="line">        <span class="comment">// print</span></div>
<div class="line">        <a class="code hl_class" href="classmuda_1_1_parallel_for.html">ParallelFor</a>(256).apply(N.eval(),</div>
<div class="line">                               [x = x.ceval().cviewer(),</div>
<div class="line">                                y = y.ceval().cviewer(),</div>
<div class="line">                                N = N.eval()] __device__(<span class="keywordtype">int</span> i) <span class="keyword">mutable</span></div>
<div class="line">                               {</div>
<div class="line">                                   <span class="keywordflow">if</span>(N &lt;= 10)</div>
<div class="line">                                       print(<span class="stringliteral">&quot;[%d] x = (%f,%f,%f) y = (%f,%f,%f) \n&quot;</span>,</div>
<div class="line">                                             i,</div>
<div class="line">                                             x(i).x(),</div>
<div class="line">                                             x(i).y(),</div>
<div class="line">                                             x(i).z(),</div>
<div class="line">                                             y(i).x(),</div>
<div class="line">                                             y(i).y(),</div>
<div class="line">                                             y(i).z());</div>
<div class="line">                               });</div>
<div class="line">    };</div>
<div class="line">    <span class="comment">// 3) visualize it using graphviz (for debug)</span></div>
<div class="line">    graph.graphviz(std::cout);</div>
<div class="line">}</div>
<div class="ttc" id="aclassmuda_1_1_compute_graph_html"><div class="ttname"><a href="classmuda_1_1_compute_graph.html">muda::ComputeGraph</a></div><div class="ttdef"><b>Definition</b> compute_graph.h:38</div></div>
<div class="ttc" id="aclassmuda_1_1_compute_graph_var_manager_html"><div class="ttname"><a href="classmuda_1_1_compute_graph_var_manager.html">muda::ComputeGraphVarManager</a></div><div class="ttdef"><b>Definition</b> compute_graph_var_manager.h:15</div></div>
</div><!-- fragment --><p><img src="./img/compute_graph.svg" alt="graphviz" style="pointer-events: none;" class="inline"/></p>
<p>Launch a muda compute graph:</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> compute_graph_simple()</div>
<div class="line">{</div>
<div class="line">    <span class="comment">// resources</span></div>
<div class="line">    <span class="keyword">auto</span> N_value    = 4;</div>
<div class="line">    <span class="keyword">auto</span> x_0_buffer = <a class="code hl_class" href="classmuda_1_1_device_vector.html">DeviceVector&lt;Vector3&gt;</a>(N_value);</div>
<div class="line">    <span class="keyword">auto</span> x_buffer   = <a class="code hl_class" href="classmuda_1_1_device_vector.html">DeviceVector&lt;Vector3&gt;</a>(N_value);</div>
<div class="line">    <span class="keyword">auto</span> y_buffer   = <a class="code hl_class" href="classmuda_1_1_device_vector.html">DeviceVector&lt;Vector3&gt;</a>(N_value);</div>
<div class="line"> </div>
<div class="line">    N.update(N_value);</div>
<div class="line">    x_0.update(x_0_buffer);</div>
<div class="line">    x.update(x_buffer);</div>
<div class="line">    y.update(y_buffer);</div>
<div class="line">    </div>
<div class="line">    <span class="comment">// create stream</span></div>
<div class="line">    <a class="code hl_class" href="classmuda_1_1_stream.html">Stream</a> stream;</div>
<div class="line">    <span class="comment">// sync graph on stream</span></div>
<div class="line">    graph.launch(stream);</div>
<div class="line">    <span class="comment">// launch all nodes on a single stream (fallback to origin cuda kernel launch)</span></div>
<div class="line">    graph.launch(<span class="keyword">true</span>, stream);</div>
<div class="line">}</div>
<div class="ttc" id="aclassmuda_1_1_device_vector_html"><div class="ttname"><a href="classmuda_1_1_device_vector.html">muda::DeviceVector</a></div><div class="ttdef"><b>Definition</b> vector.h:23</div></div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md11"></a>
Dynamic Parallelism</h2>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> dynamic_parallelism_graph()</div>
<div class="line">{</div>
<div class="line">    std::vector&lt;int&gt; host(16);</div>
<div class="line">    std::iota(host.begin(), host.end(), 0);</div>
<div class="line"> </div>
<div class="line">    <a class="code hl_class" href="classmuda_1_1_compute_graph_var_manager.html">ComputeGraphVarManager</a> manager;</div>
<div class="line">    <span class="comment">// create graph</span></div>
<div class="line">    <a class="code hl_class" href="classmuda_1_1_compute_graph.html">ComputeGraph</a>      graph{manager, <span class="stringliteral">&quot;graph&quot;</span>, ComputeGraphFlag::DeviceLaunch};</div>
<div class="line">    <span class="comment">// create resource</span></div>
<div class="line">    <a class="code hl_class" href="classmuda_1_1_device_buffer.html">DeviceBuffer&lt;int&gt;</a> src = host;</div>
<div class="line">    <a class="code hl_class" href="classmuda_1_1_device_buffer.html">DeviceBuffer&lt;int&gt;</a> dst(host.size());</div>
<div class="line">    </div>
<div class="line">    <span class="comment">// create graph var</span></div>
<div class="line">    <span class="keyword">auto</span>&amp; src_var = manager.create_var(<span class="stringliteral">&quot;src&quot;</span>, src.view());</div>
<div class="line">    <span class="keyword">auto</span>&amp; dst_var = manager.create_var(<span class="stringliteral">&quot;dst&quot;</span>, dst.view());</div>
<div class="line">    </div>
<div class="line">    <span class="comment">// create graph node</span></div>
<div class="line">    graph.$node(<span class="stringliteral">&quot;copy&quot;</span>)</div>
<div class="line">    {</div>
<div class="line">        <a class="code hl_class" href="classmuda_1_1_buffer_launch.html">BufferLaunch</a>().copy(dst_var, src_var);</div>
<div class="line">    };</div>
<div class="line">    <span class="comment">// build graph</span></div>
<div class="line">    graph.build();</div>
<div class="line">    </div>
<div class="line">    <span class="comment">// create a scheduler graph</span></div>
<div class="line">    <a class="code hl_class" href="classmuda_1_1_compute_graph.html">ComputeGraph</a> launch_graph{manager, <span class="stringliteral">&quot;launch_graph&quot;</span>, ComputeGraphFlag::DeviceLaunch};</div>
<div class="line">    <span class="keyword">auto</span>&amp; graph_var = manager.create_var(<span class="stringliteral">&quot;graph&quot;</span>, graph.viewer());</div>
<div class="line">    </div>
<div class="line">    <span class="comment">// create a node to launch our graph</span></div>
<div class="line">    launch_graph.$node(<span class="stringliteral">&quot;launch&quot;</span>)</div>
<div class="line">    {</div>
<div class="line">        <a class="code hl_class" href="classmuda_1_1_launch.html">Launch</a>().apply(</div>
<div class="line">            [graph = graph_var.ceval()] $()</div>
<div class="line">            {</div>
<div class="line">                graph.tail_launch();</div>
<div class="line">            });</div>
<div class="line">    };</div>
<div class="line">    <span class="comment">// graphviz all graph we created</span></div>
<div class="line">    manager.graphviz(std::cout);</div>
<div class="line">    <span class="comment">// launch and wait</span></div>
<div class="line">    launch_graph.launch().wait();</div>
<div class="line">}</div>
</div><!-- fragment --><p><img src="./img/dynamic_parallelism.svg" alt="image-20231119161837442" style="pointer-events: none;" class="inline"/></p>
<h2><a class="anchor" id="autotoc_md12"></a>
MUDA vs. CUDA</h2>
<div class="fragment"><div class="line"><span class="comment">/* </span></div>
<div class="line"><span class="comment">* muda style</span></div>
<div class="line"><span class="comment">*/</span></div>
<div class="line"><span class="keywordtype">void</span> muda()</div>
<div class="line">{</div>
<div class="line">    <a class="code hl_class" href="classmuda_1_1_device_buffer.html">DeviceBuffer&lt;int&gt;</a>  dv(64);</div>
<div class="line">    dv.fill(1);</div>
<div class="line">    </div>
<div class="line">    <a class="code hl_class" href="classmuda_1_1_parallel_for.html">ParallelFor</a>(256) <span class="comment">// parallel-semantic</span></div>
<div class="line">        .kernel_name(<span class="stringliteral">&quot;my_kernel&quot;</span>) <span class="comment">// or just .kernel_name(__FUNCTION__)</span></div>
<div class="line">        .apply(64, <span class="comment">// automatically cover the range</span></div>
<div class="line">               [</div>
<div class="line">                   <span class="comment">// mapping from the DeviceBuffer to a proper viewer</span></div>
<div class="line">                   <span class="comment">// which can be trivially copy through device and host</span></div>
<div class="line">                   dv = dv.viewer().name(<span class="stringliteral">&quot;dv&quot;</span>)</div>
<div class="line">               ] </div>
<div class="line">               __device__(<span class="keywordtype">int</span> i) <span class="keyword">mutable</span></div>
<div class="line">               { </div>
<div class="line">                   dv(i) *= 2; <span class="comment">// safe, the viewer check the boundary automatically</span></div>
<div class="line">               })</div>
<div class="line">        .wait();<span class="comment">// happy waiting, muda remember the stream.</span></div>
<div class="line">        <span class="comment">//.apply(...) //if you want to go forward with the same config, just call .apply() again.</span></div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment">/* </span></div>
<div class="line"><span class="comment">* cuda style</span></div>
<div class="line"><span class="comment">*/</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">// manually create kernel</span></div>
<div class="line">__global__ <span class="keywordtype">void</span> times2(<span class="keywordtype">int</span>* i, <span class="keywordtype">int</span> N) <span class="comment">// modifying parameters is horrible</span></div>
<div class="line">{</div>
<div class="line">    <span class="keyword">auto</span> tid = threadIdx.x;</div>
<div class="line">    <span class="keywordflow">if</span>(tid &lt; N) <span class="comment">// check corner case manaully</span></div>
<div class="line">    {</div>
<div class="line">        i[tid] *= 2;<span class="comment">// unsafe: no boundary check at all</span></div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> cuda()</div>
<div class="line">{</div>
<div class="line">    <span class="comment">// to be brief, we just use thrust to allocate memory</span></div>
<div class="line">    thrust::device_vector&lt;int&gt; dv(64, 1);</div>
<div class="line">    <span class="comment">// cast to raw pointer</span></div>
<div class="line">    <span class="keyword">auto</span> dvptr = thrust::raw_pointer_cast(dv.data());</div>
<div class="line">    <span class="comment">// create stream and check error</span></div>
<div class="line">    cudaStream_t s;</div>
<div class="line">    checkCudaErrors(cudaStreamCreate(&amp;s));</div>
<div class="line">    <span class="comment">// call the kernel (which always ruins the Intellisense, if you use VS.)</span></div>
<div class="line">    times2&lt;&lt;&lt;1, 64, 0, s&gt;&gt;&gt;(dvptr, dv.size());</div>
<div class="line">    <span class="comment">// boring waiting and error checking</span></div>
<div class="line">    checkCudaErrors(cudaStreamSynchronize(s));</div>
<div class="line">}</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md13"></a>
Build</h1>
<h2><a class="anchor" id="autotoc_md14"></a>
Xmake</h2>
<p>Run example:</p>
<div class="fragment"><div class="line">$ xmake f --example=true</div>
<div class="line">$ xmake </div>
<div class="line">$ xmake run muda_example hello_muda</div>
</div><!-- fragment --><p> To show all examples:</p>
<div class="fragment"><div class="line">$ xmake run muda_example -l</div>
</div><!-- fragment --><p> Play all examples:</p>
<div class="fragment"><div class="line">$ xmake run muda_example</div>
</div><!-- fragment --> <h2><a class="anchor" id="autotoc_md15"></a>
Cmake</h2>
<div class="fragment"><div class="line">$ mkdir CMakeBuild</div>
<div class="line">$ cd CMakeBuild</div>
<div class="line">$ cmake -S ..</div>
<div class="line">$ cmake --build .</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md16"></a>
Copy Headers</h2>
<p>Because <b>muda</b> is header-only, copy the <code>src/muda/</code> folder to your project, set the include directory, and everything is done.</p>
<h2><a class="anchor" id="autotoc_md17"></a>
Macro</h2>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Macro   </th><th class="markdownTableHeadNone">Value   </th><th class="markdownTableHeadNone">Details    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>MUDA_CHECK_ON</code>   </td><td class="markdownTableBodyNone"><code>1</code>(default) or <code>0</code>   </td><td class="markdownTableBodyNone"><code>MUDA_CHECK_ON=1</code> for turn on all muda runtime check(for safety)    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><code>MUDA_WITH_COMPUTE_GRAPH</code>   </td><td class="markdownTableBodyNone"><code>1</code>or<code>0</code>(default)   </td><td class="markdownTableBodyNone"><code>MUDA_WITH_COMPUTE_GRAPH=1</code> for turn on muda compute graph feature   </td></tr>
</table>
<p>If you manually copy the header files, don't forget to define the macros yourself. If you use cmake or xmake, just set the project dependency to muda.</p>
<h1><a class="anchor" id="autotoc_md18"></a>
Tutorial</h1>
<ul>
<li><a href="https://zhuanlan.zhihu.com/p/659664377">tutorial_zh</a></li>
<li>If you need an English version tutorial, please contact me or post an issue to let me know.</li>
</ul>
<h1><a class="anchor" id="autotoc_md19"></a>
Documentation</h1>
<p>Documentation is maintained on <a href="https://codedocs.xyz/MuGdxy/muda/">https://codedocs.xyz/MuGdxy/muda/</a>. And you can also build the doc by yourself.</p>
<h1><a class="anchor" id="autotoc_md20"></a>
Examples</h1>
<ul>
<li><a href="./example/">examples</a></li>
</ul>
<p>All examples in <code>muda/example</code> are self-explanatory, enjoy it.</p>
<p><img src="./img/example-img.png" alt="image-20231102030703199" class="inline"/></p>
<h1><a class="anchor" id="autotoc_md21"></a>
Contributing</h1>
<p>Contributions are welcome. We are looking for or are working on:</p>
<ol type="1">
<li><b>muda</b> development</li>
<li>fancy simulation demos using <b>muda</b></li>
<li>better documentation of <b>muda</b></li>
</ol>
<h1><a class="anchor" id="autotoc_md22"></a>
Related Work</h1>
<ul>
<li><p class="startli">Topological braiding simulation using <b>muda</b> (old version)</p>
<div class="fragment"><div class="line">@article{article,</div>
<div class="line">author = {Lu, Xinyu and Bo, Pengbo and Wang, Linqin},</div>
<div class="line">year = {2023},</div>
<div class="line">month = {07},</div>
<div class="line">pages = {},</div>
<div class="line">title = {Real-Time 3D Topological Braiding Simulation with Penetration-Free Guarantee},</div>
<div class="line">volume = {164},</div>
<div class="line">journal = {Computer-Aided Design},</div>
<div class="line">doi = {10.1016/j.cad.2023.103594}</div>
<div class="line">}</div>
</div><!-- fragment --><p class="startli"><img src="./img/braiding.png" alt="braiding" class="inline"/> </p>
</li>
</ul>
</div></div><!-- PageDoc -->
</div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.8
</small></address>
</body>
</html>
